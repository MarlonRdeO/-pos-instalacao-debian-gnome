#!/bin/bash

# ==========================================================================
# SCRIPT DE PÓS-INSTALAÇÃO AUTOMATIZADA (DEBIAN 13 GNOME) - CORRIGIDO
# ==========================================================================

GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[1;34m'
RED='\033[0;31m'
NC='\033[0m'

clear
echo -e "${BLUE}=====================================================${NC}"
echo -e "${BLUE}        RESUMO DA INSTALAÇÃO (DEBIAN 13 GNOME)        ${NC}"
echo -e "${BLUE}=====================================================${NC}"
echo -e "Corrigido: Alias de atualização e Login Automático GDM3"
echo -e "${BLUE}=====================================================${NC}"
echo -n "Deseja prosseguir com a correção e instalação? (s/n): "
read -r confirmacao

if [[ "$confirmacao" != "s" && "$confirmacao" != "S" ]]; then
    echo -e "${RED}Cancelado.${NC}"
    exit 0
fi

# --- FASE 1: ATUALIZAÇÃO E APT ---
echo -e "${YELLOW}Fase 1: Instalando pacotes APT...${NC}"
sudo apt update && sudo apt upgrade -y
sudo apt install -y \
    gdebi synaptic vlc openssh-server openssh-client hardinfo nmap bmon \
    zenity wget galculator htop net-tools \
    vim gimp g++ alacarte samba xorg ssh nmon \
    zsh baobab firmware-linux-nonfree gparted tlp build-essential \
    kdenlive file-roller bash-completion nala \
    gnome-tweaks gnome-shell-extension-manager bilibop-common bilibop-lockfs 

# --- FASE 2: CONFIGURAÇÃO FLATPAK E SNAP ---
echo -e "${YELLOW}Fase 2: Configurando Flatpak e Snap...${NC}"
sudo apt install -y flatpak snapd gnome-software-plugin-flatpak
sudo flatpak remote-add --if-not-exists flathub https://flathub.org/repo/flathub.flatpakrepo
sudo systemctl enable --now snapd.socket
[ ! -L /snap ] && sudo ln -s /var/lib/snapd/snap /snap

# --- FASE 3: APPS FLATPAK E LIMPEZA ---
echo -e "${YELLOW}Fase 3: Instalando Flatpaks e removendo bloatware...${NC}"
apps=(org.onlyoffice.desktopeditors io.github.peazip.PeaZip)
for app in "${apps[@]}"; do
    sudo flatpak install --assumeyes flathub "$app"
done

sudo apt purge -y gnome-robots gnome-2048 gnome-mahjongg iagno gnome-chess \
    five-or-more gnome-klotski lightsoff gnome-mines four-in-a-row gnome-sudoku \
    gnome-taquin gnome-tetravex hitori quadrapassel aisleriot swell-foop \
    gnome-nibbles tali thunderbird libreoffice* rhythmbox cheese totem
sudo apt autoremove -y

# --- FASE 4: ALIASES (CORREÇÃO DO 'LIAS') ---
echo -e "${YELLOW}Fase 4: Adicionando Aliases corrigidos...${NC}"
# Limpa aliases antigos para evitar duplicidade ou erros anteriores
sed -i '/# === ALIASES ÚTEIS ===/,/Summary/d' ~/.bashrc

cat << 'EOF' >> ~/.bashrc
# === ALIASES ÚTEIS ===
alias atualizar='sudo nala update && sudo nala upgrade -y && sudo flatpak update -y && sudo snap refresh'
alias desligar='systemctl poweroff'
alias reiniciar='systemctl reboot'
alias sourceslist='sudo nano /etc/apt/sources.list'
alias memoriaram='sudo nano /etc/sysctl.conf'
alias renomearpc='sudo nano /etc/hostname'
alias tab='sudo nano /etc/bash.bashrc'
alias ip='ip route | grep default'
alias macinfo='for iface in $(ls /sys/class/net); do echo -n "$iface: "; cat /sys/class/net/$iface/address; done'
alias limparhistorico='history -c'
# ======================
EOF

# Otimização Swappiness
if ! grep -q "vm.swappiness=10" /etc/sysctl.conf; then
    echo "vm.swappiness=10" | sudo tee -a /etc/sysctl.conf > /dev/null
    sudo sysctl -p > /dev/null
fi

# --- FASE 5: AUTO-COMPLETAR (TAB) ---
sudo sed -i '/^#[[:space:]]*if ! shopt -oq posix; then/,/^[[:space:]]*#fi/{s/^[[:space:]]*#//}' /etc/bash.bashrc

# --- FASE 6: LOGIN AUTOMÁTICO (CORREÇÃO GDM3) ---
echo -e "${YELLOW}Fase 6: Configurando Login Automático para 'aluno'...${NC}"
GDM_CONF="/etc/gdm3/daemon.conf"
if [ -f "$GDM_CONF" ]; then
    # Remove o comentário (#) e espaços no início da linha, e define os valores
    sudo sed -i 's/^[[:space:]]*#[[:space:]]*AutomaticLoginEnable.*/AutomaticLoginEnable = true/' "$GDM_CONF"
    sudo sed -i 's/^[[:space:]]*#[[:space:]]*AutomaticLogin[[:space:]]*=.*/AutomaticLogin = aluno/' "$GDM_CONF"
fi

# --- FASE 7: CRONTAB E BILIBOP ---
echo -e "${YELLOW}Fase 7 e 8: Crontab e Bilibop...${NC}"
sudo sed -i '/shutdown -h now/d' /etc/crontab
echo "30 23   * * * root    /sbin/shutdown -h now" | sudo tee -a /etc/crontab > /dev/null

echo 'BILIBOP_LOCKFS="true"' | sudo tee /etc/bilibop/bilibop.conf > /dev/null

# --- FASE 9: FINALIZAÇÃO ---
echo -e "${GREEN}CONCLUÍDO! Reiniciando...${NC}"
sleep 5
sudo reboot
